"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([[3255],{1660:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>c,contentTitle:()=>a,default:()=>d,frontMatter:()=>s,metadata:()=>o,toc:()=>l});var n=r(4848),i=r(8453);const s={title:"Canary/Traffic Split",sidebar_position:40,weight:5},a=void 0,o={id:"traffic-management/canary-split-traffic",title:"Canary/Traffic Split",description:"One of the productpage's backend services is reviews. The reviews comes in three different pod versions, which are created from three separate deployments. All versions labeled with app=reviews which is the selector used in the reviews service.",source:"@site/docs/20-traffic-management/30-canary-split-traffic.md",sourceDirName:"20-traffic-management",slug:"/traffic-management/canary-split-traffic",permalink:"/docs/traffic-management/canary-split-traffic",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/20-traffic-management/30-canary-split-traffic.md",tags:[],version:"current",sidebarPosition:40,frontMatter:{title:"Canary/Traffic Split",sidebar_position:40,weight:5},sidebar:"trafficManagementSidebar",previous:{title:"Exposing a service with ISTIO Ingress Gateway",permalink:"/docs/traffic-management/expose_a_service"},next:{title:"Identity Based Routing",permalink:"/docs/traffic-management/identity-based-routing"}},c={},l=[];function h(e){const t={code:"code",em:"em",img:"img",p:"p",pre:"pre",strong:"strong",...(0,i.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(t.p,{children:["One of the ",(0,n.jsx)(t.em,{children:"productpage"}),"'s backend services is ",(0,n.jsx)(t.em,{children:"reviews"}),". The reviews comes in three different pod versions, which are created from three separate deployments. All versions labeled with ",(0,n.jsx)(t.code,{children:"app=reviews"})," which is the selector used in the reviews service."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-shell",children:"kubectl get pods -n test -l app=reviews\n"})}),"\n",(0,n.jsx)(t.p,{children:"Output:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-shell",children:"NAME                          READY   STATUS    RESTARTS   AGE\r\nreviews-v1-9c6bb6658-s97gt    2/2     Running   0          5h32m\r\nreviews-v2-8454bb78d8-f9r25   2/2     Running   0          5h32m\r\nreviews-v3-6dc9897554-5fnqp   2/2     Running   0          5h32m\n"})}),"\n",(0,n.jsx)(t.p,{children:"As a result, when you hit the product page, kubernetes will just distribute traffic equally to all versions as you see in the output of the following loop command."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-shell",children:'for i in {1..6}; do curl -s $ISTIO_IG_HOSTNAME/productpage | grep "reviews-" & sleep 1; done\n'})}),"\n",(0,n.jsx)(t.p,{children:"Output:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-shell",children:'[1] 3935\r\n        <u>reviews-v1-9c6bb6658-s97gt</u>\r\n[1]+  Done                    curl -s $ISTIO_IG_HOSTNAME/productpage | grep --color=auto "reviews-"\r\n[1] 3998\r\n        <u>reviews-v2-8454bb78d8-f9r25</u>\r\n[1]+  Done                    curl -s $ISTIO_IG_HOSTNAME/productpage | grep --color=auto "reviews-"\r\n[1] 4101\r\n        <u>reviews-v1-9c6bb6658-s97gt</u>\r\n[1]+  Done                    curl -s $ISTIO_IG_HOSTNAME/productpage | grep --color=auto "reviews-"\r\n[1] 4111\r\n        <u>reviews-v3-6dc9897554-5fnqp</u>\r\n[1]+  Done                    curl -s $ISTIO_IG_HOSTNAME/productpage | grep --color=auto "reviews-"\r\n[1] 4121\r\n        <u>reviews-v2-8454bb78d8-f9r25</u>\r\n[1]+  Done                    curl -s $ISTIO_IG_HOSTNAME/productpage | grep --color=auto "reviews-"\r\n[1] 4169\r\n        <u>reviews-v3-6dc9897554-5fnqp</u>\r\n[1]+  Done                    curl -s $ISTIO_IG_HOSTNAME/productpage | grep --color=auto "reviews-"\n'})}),"\n",(0,n.jsxs)(t.p,{children:["Now, let's open ",(0,n.jsx)(t.strong,{children:"Kiali"}),". Get the DNS name of the AWS ALB of Kilai, then hit it in the browser.\r\n",(0,n.jsx)(t.img,{alt:"productpage",src:r(1327).A+"",width:"1190",height:"569"})]}),"\n",(0,n.jsxs)(t.p,{children:["Navigate to ",(0,n.jsx)(t.em,{children:"Graph"})," in the Kiali dashboard. Choose the ",(0,n.jsx)(t.em,{children:"test"}),' namespace next. Then, in the display dropdown, tick the boxes next to "Traffic Animation" and "Traffic Distribution". Finally, set the ',(0,n.jsx)(t.em,{children:"Traffic metric per refresh"})," to ",(0,n.jsx)(t.strong,{children:"Last 5m"}),", and the ",(0,n.jsx)(t.em,{children:"Refresh interval"})," to ",(0,n.jsx)(t.strong,{children:"Every 10s"}),"."]}),"\n",(0,n.jsx)(t.p,{children:"Now, execute the same loop command again for enough time and while the loop is running, check how Kiali shows the distribution of traffic to the 3 pod versions of the reviews service, which should still be almost equally distributed."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-shell",children:'for i in {1..300}; do curl -s $ISTIO_IG_HOSTNAME/productpage | grep "reviews-" & sleep 1; done\n'})}),"\n",(0,n.jsx)(t.p,{children:"Wait a minute, and then you will notice that the traffic to the reviews versions are distributed amost equally."}),"\n",(0,n.jsxs)(t.p,{children:["You now understand the behavior of Kubernetes when distributing traffic to different versions of service backend pods. But the question now is, how to route traffic to each version by percentage of the coming taffic?\r\n",(0,n.jsx)(t.img,{alt:"split-pattern",src:r(2366).A+"",width:"686",height:"330"})]}),"\n",(0,n.jsx)(t.p,{children:"For example, the reviews service backed by 3 different versions. Is it possible to route 80% of traffic to v1, 10% to v2, and 10% to v3?"}),"\n",(0,n.jsxs)(t.p,{children:["Yes, you can easily accomplish this with Istio by creating a ",(0,n.jsx)(t.code,{children:"VirtualService"})," that lists the different versions subsets with their weights, and a ",(0,n.jsx)(t.code,{children:"DestinationRule"})," that defines policies that apply to traffic intended for a service after routing has occurred."]}),"\n",(0,n.jsxs)(t.p,{children:["Now, each deployment version is labeled with the label ",(0,n.jsx)(t.code,{children:"version"}),", but with a different value. For example deployment of version 1, has the version label defined like this ",(0,n.jsx)(t.code,{children:"version=v1"}),", and deployment of version 2, has the version label defined like this ",(0,n.jsx)(t.code,{children:"version=v2"}),", etc."]}),"\n",(0,n.jsx)(t.p,{children:"For example, if you want to list reviews pods of version 1, run the following command:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-shell",children:"kubectl get pod -n test -l version=v1 | grep reviews\n"})}),"\n",(0,n.jsx)(t.p,{children:"Output:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-shell",children:"reviews-v1-9c6bb6658-s97gt       2/2     Running   0          22h\n"})}),"\n",(0,n.jsx)(t.p,{children:"Now, let's define a subset per version using a DestinationRule. The label attached to the pods of each version must match the label defined here for each subset."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-yaml",children:"kubectl apply -n test -f - <<EOF\r\napiVersion: networking.istio.io/v1alpha3\r\nkind: DestinationRule\r\nmetadata:\r\n  name: reviews\r\nspec:\r\n  host: reviews # reviews.<namespace>.svc.cluster.local\r\n  subsets: \r\n  - name: v1\r\n    labels:\r\n      version: v1 # This is a label attached to the pods of version 1.\r\n  - name: v2\r\n    labels:\r\n      version: v2 # This is a label attached to the pods of version 2.\r\n  - name: v3\r\n    labels:\r\n      version: v3 # This is a label attached to the pods of version 3.\r\nEOF\n"})}),"\n",(0,n.jsx)(t.p,{children:'For the weight-based routing to happen, you create a VirtualService where you define a routing rule per version. Weights associated with the version determine the proportion of traffic it receives. For example, the rules defined here will route 80% of traffic for the \u201creviews\u201d service to instances with the \u201cv1\u201d label 10% of traffic for "v2", and the remaining 10% for "v3".'}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-yaml",children:"kubectl apply -n test -f - <<EOF\r\napiVersion: networking.istio.io/v1alpha3\r\nkind: VirtualService\r\nmetadata:\r\n  name: reviews\r\nspec:\r\n  hosts:\r\n  - reviews # reviews.<namespace>.svc.cluster.local\r\n  gateways: \r\n    # Here you bind this virtualService to the gateway bookinfo-gateway, and to the whole mesh. \r\n    # Which means that the rules of this virtualservice will apply to this gateway level, and to the whole mesh. \r\n  - bookinfo-gateway \r\n  - mesh \r\n  http: \r\n  - route:\r\n    - destination:\r\n        host: reviews\r\n        subset: v1\r\n      weight: 80 \r\n    - destination:\r\n        host: reviews\r\n        subset: v2\r\n      weight: 10\r\n    - destination:\r\n        host: reviews\r\n        subset: v3\r\n      weight: 10\r\nEOF\n"})}),"\n",(0,n.jsx)(t.p,{children:"Now, execute the same loop command you executed earlier."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-shell",children:'for i in {1..300}; do curl -s $ISTIO_IG_HOSTNAME/productpage | grep "reviews-" & sleep 1; done\n'})}),"\n",(0,n.jsxs)(t.p,{children:["Wait a minute, and then Open Kiali to look at the distribution of traffic to the 3 pod versions of the reviews service,\r\n",(0,n.jsx)(t.img,{alt:"kiali-reviews-weight-traffic",src:r(9638).A+"",width:"960",height:"633"}),"\r\nThis time, the traffic to the reviews versions are distributed following the weight based rules we defined in the VirtualService."]}),"\n",(0,n.jsxs)(t.p,{children:["You can also use this weight-based method to gradually ",(0,n.jsx)(t.code,{children:"traffic shifting"})," from one version to another, or to have ",(0,n.jsx)(t.code,{children:"Canary Deployment"})," to test a newer version of a service by incrementally rolling out to users to minimize the risk and impact of any bugs introduced by the newer version."]})]})}function d(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(h,{...e})}):h(e)}},9638:(e,t,r)=>{r.d(t,{A:()=>n});const n=r.p+"assets/images/kiali-reviews-weight-traffic-d6837d83a9de1ce67998779419804a64.png"},1327:(e,t,r)=>{r.d(t,{A:()=>n});const n=r.p+"assets/images/productpage-55271aa782d72e80d44d1bbf8756e149.png"},2366:(e,t,r)=>{r.d(t,{A:()=>n});const n=r.p+"assets/images/split-pattern-302c5898e0d77a76b1e29c71c9a268cf.png"},8453:(e,t,r)=>{r.d(t,{R:()=>a,x:()=>o});var n=r(6540);const i={},s=n.createContext(i);function a(e){const t=n.useContext(s);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),n.createElement(s.Provider,{value:t},e.children)}}}]);