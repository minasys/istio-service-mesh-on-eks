"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([[3144],{8087:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>c,contentTitle:()=>a,default:()=>l,frontMatter:()=>r,metadata:()=>o,toc:()=>d});var n=s(4848),i=s(8453);const r={title:"Identity Based Routing",sidebar_position:40,weight:5},a=void 0,o={id:"traffic-management/identity-based-routing",title:"Identity Based Routing",description:"In this task, you use Istio to send 100% of the traffic to reviews-v1. You then set a rule to selectively send traffic to reviews-v2 based on a custom end-user header added to the request by the productpage service. In this case, all traffic from a user named tester will be routed to the service reviews:v2, but all remaining traffic goes to reviews-v1.",source:"@site/docs/20-traffic-management/40-identity-based-routing.md",sourceDirName:"20-traffic-management",slug:"/traffic-management/identity-based-routing",permalink:"/istio-service-mesh-on-eks/docs/traffic-management/identity-based-routing",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/20-traffic-management/40-identity-based-routing.md",tags:[],version:"current",sidebarPosition:40,frontMatter:{title:"Identity Based Routing",sidebar_position:40,weight:5},sidebar:"trafficManagementSidebar",previous:{title:"Canary/Traffic Split",permalink:"/istio-service-mesh-on-eks/docs/traffic-management/canary-split-traffic"},next:{title:"Circuit Breaking",permalink:"/istio-service-mesh-on-eks/docs/traffic-management/circuit-breaking"}},c={},d=[];function h(e){const t={code:"code",em:"em",img:"img",p:"p",pre:"pre",strong:"strong",...(0,i.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(t.p,{children:["In this task, you use Istio to send 100% of the traffic to ",(0,n.jsx)(t.code,{children:"reviews-v1"}),". You then set a rule to selectively send traffic to ",(0,n.jsx)(t.code,{children:"reviews-v2"})," based on a custom end-user header added to the request by the productpage service. In this case, all traffic from a user named ",(0,n.jsx)(t.em,{children:"tester"})," will be routed to the service ",(0,n.jsx)(t.code,{children:"reviews:v2"}),", but all remaining traffic goes to ",(0,n.jsx)(t.code,{children:"reviews-v1"}),"."]}),"\n",(0,n.jsxs)(t.p,{children:[(0,n.jsx)(t.code,{children:"reviews:v1"})," is the version that does not include the star ratings feature. ",(0,n.jsx)(t.code,{children:"reviews:v2"})," is the version that includes the star ratings feature."]}),"\n",(0,n.jsx)(t.p,{children:"Run the following command to re-configure the virtualService reviews you created in the previous task with the following one to enable user-based routing:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-yaml",children:"kubectl apply -n test -f - <<EOF\r\napiVersion: networking.istio.io/v1alpha3\r\nkind: VirtualService\r\nmetadata:\r\n  name: reviews\r\nspec:\r\n  hosts: \r\n  - reviews\r\n  \r\n  # When this field is omitted, the default gateway (mesh) will be used, which would apply the rules to all sidecars in the mesh. \r\n  # If a list of gateway names is provided, the rules will apply only to those gateways. \r\n  # To apply the rules to both gateways and sidecars, specify mesh as one of the gateway names.\r\n  gateways:\r\n  - bookinfo-gateway\r\n  - mesh\r\n  http: \r\n  - match: \r\n    - headers:\r\n        end-user:\r\n          exact: tester\r\n    route:\r\n    - destination:\r\n        host: reviews\r\n        subset: v2\r\n      weight: 100\r\n  - route:\r\n    - destination:\r\n        host: reviews\r\n        subset: v1      \r\nEOF\n"})}),"\n",(0,n.jsx)(t.p,{children:"Now, let's open the productpage using the browser:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-shell",children:"echo $ISTIO_IG_HOSTNAME/productpage\n"})}),"\n",(0,n.jsx)(t.p,{children:"Output:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-shell",children:"ac8bed13fd78247e995b42664063ce47-1403049919.us-east-1.elb.amazonaws.com/productpage\n"})}),"\n",(0,n.jsxs)(t.p,{children:["Notice here before logging, that the displayed page shows ",(0,n.jsx)(t.code,{children:"reviews-v1"})," and does not includes the star ratings feature.\r\n",(0,n.jsx)(t.img,{alt:"productpage-with-no-user-identity",src:s(5399).A+"",width:"1026",height:"496"})]}),"\n",(0,n.jsxs)(t.p,{children:["Now, let's see what happens when logging with the ",(0,n.jsx)(t.em,{children:"tester"})," user?"]}),"\n",(0,n.jsxs)(t.p,{children:["Hit the ",(0,n.jsx)(t.code,{children:"Sign In"})," button, to log in with the ",(0,n.jsx)(t.code,{children:"tester"})," user, with no password:"]}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{alt:"tester-login",src:s(2750).A+"",width:"920",height:"257"})}),"\n",(0,n.jsxs)(t.p,{children:["Once the tester user is in, you will notice that the displayed page include the star ratings feature and show ",(0,n.jsx)(t.code,{children:"reviews-v2"})," as it's expected."]}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{alt:"login-with-tester",src:s(9203).A+"",width:"595",height:"482"})}),"\n",(0,n.jsxs)(t.p,{children:["And if you singed out and signed in back with any user other than ",(0,n.jsx)(t.em,{children:"tester"})," (pick any name you wish). You will see that review stars are not there and it shows reviews-v1. This is because traffic is routed to reviews",":v1"," for all users except tester."]}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{alt:"not-tester",src:s(8894).A+"",width:"606",height:"436"})}),"\n",(0,n.jsx)(t.p,{children:"You have successfully configured Istio to route traffic based on user identity."}),"\n",(0,n.jsxs)(t.p,{children:[(0,n.jsx)(t.strong,{children:"Try it out:"})," Change the routing rule to direct tester user to v1, and remaining traffic to goes to v2."]})]})}function l(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(h,{...e})}):h(e)}},9203:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/login-with-tester-bcdea91104895c6b41e52dd6c21e0669.png"},8894:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/not-tester-4284fa51b2ab94f1c8f8342dc46fa42e.png"},5399:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/productpage-with-no-user-identity-c889cf3e8c18f46b87ea8405b98136df.png"},2750:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/tester-login-742dee03fdd23a8c279474cf1a98eaca.png"},8453:(e,t,s)=>{s.d(t,{R:()=>a,x:()=>o});var n=s(6540);const i={},r=n.createContext(i);function a(e){const t=n.useContext(r);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),n.createElement(r.Provider,{value:t},e.children)}}}]);