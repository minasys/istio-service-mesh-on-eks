"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([[9752],{5654:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>i,toc:()=>d});var r=s(4848),t=s(8453);const o={title:"Enabling ISTIO and Prometheus",sidebar_position:30},a=void 0,i={id:"setup/enabling-istio-and-prometheus",title:"Enabling ISTIO and Prometheus",description:"After creating your cluster with the default addons that comes with the EKS Blueprints module example eks-cluster-with-new-vpc, you can enable or disable whatever addon you need, as long as it has a module for it under the directory modules/kubernetes-addons. You can ALSO create your own addon module, if there is no existing module already for it in the repository.",source:"@site/docs/10-setup/30-enabling-istio-and-prometheus.md",sourceDirName:"10-setup",slug:"/setup/enabling-istio-and-prometheus",permalink:"/istio-service-mesh-on-eks/docs/setup/enabling-istio-and-prometheus",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/10-setup/30-enabling-istio-and-prometheus.md",tags:[],version:"current",sidebarPosition:30,frontMatter:{title:"Enabling ISTIO and Prometheus",sidebar_position:30},sidebar:"setupSidebar",previous:{title:"Creating an EKS cluster with EKS Blueprints",permalink:"/istio-service-mesh-on-eks/docs/setup/creating-an-eks-cluster"},next:{title:"Exposing ISTIO Metrics to Prometheus",permalink:"/istio-service-mesh-on-eks/docs/setup/expose-istio-metrics"}},l={},d=[];function c(e){const n={a:"a",blockquote:"blockquote",br:"br",code:"code",em:"em",img:"img",p:"p",pre:"pre",strong:"strong",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.p,{children:["After creating your cluster with the default addons that comes with the EKS Blueprints module example ",(0,r.jsx)(n.a,{href:"https://github.com/aws-ia/terraform-aws-eks-blueprints/tree/main/examples/eks-cluster-with-new-vpc",children:(0,r.jsx)(n.code,{children:"eks-cluster-with-new-vpc"})}),", you can enable or disable whatever addon you need, as long as it has a module for it under the directory ",(0,r.jsx)(n.a,{href:"https://github.com/aws-ia/terraform-aws-eks-blueprints/tree/main/modules/kubernetes-addons",children:"modules/kubernetes-addons"}),". You can ALSO create your own addon module, if there is no existing module already for it in the repository."]}),"\n",(0,r.jsxs)(n.p,{children:["Now, let's enable the addons ",(0,r.jsx)(n.code,{children:"tetrate_istio"})," and ",(0,r.jsx)(n.code,{children:"prometheus"})," addon using EKS Blueprints that we'll need throughout this chapter."]}),"\n",(0,r.jsxs)(n.p,{children:["Go into the module example directory if you are not there already, and open the ",(0,r.jsx)(n.em,{children:(0,r.jsx)(n.code,{children:"main.tf"})})," file for editing."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"cd examples/eks-cluster-with-new-vpc/\r\nvi main.tf \n"})}),"\n",(0,r.jsxs)(n.p,{children:["Add the follwoing two lines under the ",(0,r.jsx)(n.code,{children:"eks_blueprints_kubernetes_addons"})," to enable istio and prometheus on your cluster"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"  enable_tetrate_istio                = true\r\n  enable_prometheus                   = true\n"})}),"\n",(0,r.jsx)(n.p,{children:"Like so:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'module "eks_blueprints_kubernetes_addons" {\r\n  source = "../../modules/kubernetes-addons"\r\n  ...\r\n\r\n  # Add-ons\r\n  enable_aws_load_balancer_controller = true\r\n  ...\r\n\r\n  enable_tetrate_istio                = true\r\n  enable_prometheus                   = true\r\n\r\n  tags = local.tags\r\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Now, we need to configure the Prometheus module to use the Helm chart ",(0,r.jsx)(n.code,{children:"kube-prometheus-stack"})," to enable Prometheus instead of the helm chart ",(0,r.jsx)(n.code,{children:"prometheus"}),". That's becaue the chart ",(0,r.jsx)(n.code,{children:"kube-prometheus-stack"})," installs Prometheus, in addition to Grafana and Prometheus-Operator that provides CRDs like ServiceMonitor and PodMonitor, which you are going to use in the next section for exposing ISTIO metrics to Prometheus."]}),"\n",(0,r.jsxs)(n.p,{children:["The chart ",(0,r.jsx)(n.code,{children:"prometheus"})," does not include those additional services. We also need to change the chart version to ",(0,r.jsx)(n.code,{children:"35.3.1"})]}),"\n",(0,r.jsxs)(n.p,{children:["To do so, open the ",(0,r.jsx)(n.em,{children:"main.tf"})," file of the prometheus module located under ",(0,r.jsx)(n.em,{children:"modules/kubernetes-addons/prometheus/"}),", and change the ",(0,r.jsx)(n.code,{children:"chart"})," and ",(0,r.jsx)(n.code,{children:"version"})," values under the helm_config section of the module ",(0,r.jsx)(n.code,{children:"helm_addon"}),". In addition, replace the sub-value ",(0,r.jsx)(n.code,{children:"operating_system"})," with ",(0,r.jsx)(n.code,{children:"ingressClassName"})," as follow:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"cd ../../modules/kubernetes-addons/prometheus/\r\nvi main.tf\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'# module "helm_addon" {\r\nmodule "helm_addon" {\r\n  ...\r\n  helm_config = merge(\r\n    {\r\n      name        = local.name\r\n      chart       = "kube-prometheus-stack" \r\n      version     = "35.3.1" \r\n      repository  = "https://prometheus-community.github.io/helm-charts"\r\n      namespace   = local.namespace_name\r\n      description = "Prometheus helm Chart deployment configuration"\r\n      values = [templatefile("${path.module}/values.yaml", {\r\n        #operating_system = try(var.helm_config.operating_system, "linux")      # Remove this line\r\n        ingressClassName = "alb"\r\n      })]\r\n    },\r\n    var.helm_config\r\n  )\r\n\r\n...\r\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"You install this chart with the default values, except the following values that you set to expose Grafana and Prometheus services using ALB."}),"\n",(0,r.jsxs)(n.p,{children:["To do so, you create a ",(0,r.jsx)(n.em,{children:"values.yaml"})," file in the directory of the prometheus module, in the following path ",(0,r.jsx)(n.em,{children:"/modules/kubernetes-addons/prometheus/"}),", which is the path that is already referenced in the ",(0,r.jsx)(n.code,{children:"values"})," attribute under ",(0,r.jsx)(n.code,{children:"helm_config"})," under module ",(0,r.jsx)(n.code,{children:"helm_addon"})," in main.tf file (located in the prometheus module directory)."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'cat <<EOF > values.yaml\r\ngrafana:\r\n  ingress:\r\n    ## If true, Grafana Ingress will be created\r\n    enabled: true\r\n\r\n    ## IngressClassName for Grafana Ingress should be provided if Ingress is enable.\r\n    ingressClassName: ${ingressClassName} \r\n\r\n    ## Annotations for Grafana Ingress\r\n    annotations: {\r\n      alb.ingress.kubernetes.io/scheme: "internet-facing",\r\n      alb.ingress.kubernetes.io/target-type: "ip"       \r\n      }\r\n    pathType: Prefix \r\n\r\nprometheus:\r\n  ingress:\r\n    enabled: true\r\n    ingressClassName: ${ingressClassName} \r\n    annotations: {\r\n      alb.ingress.kubernetes.io/scheme: "internet-facing",\r\n      alb.ingress.kubernetes.io/target-type: "ip"       \r\n      }\r\n    pathType: Prefix \r\nEOF\n'})}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.em,{children:"Note:"})}),(0,r.jsx)(n.br,{}),"\n","You may need to set values differently when running it in production. For a full list of values check this ",(0,r.jsx)(n.a,{href:"https://raw.githubusercontent.com/prometheus-community/helm-charts/main/charts/kube-prometheus-stack/values.yaml",children:"values.yaml"})," that holds the default values that this chart has."]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["Next step, is to add the following value to the locals values in ",(0,r.jsx)(n.em,{children:"locals.tf"})," located in ",(0,r.jsx)(n.em,{children:"modules/kubernetes-addons/aws-load-balancer-controller/"}),", to enable creating ingress class resources which is needed to create the ALB of Grafana and Prometheus."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"vi ../aws-load-balancer-controller/locals.tf\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'locals {\r\n    ...\r\n    {\r\n      name  = "createIngressClassResource"\r\n      value = true\r\n    }\r\n    ...\r\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"Now you are all set to apply the resources of ISTIO and Prometheus to your EKS cluster"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"terraform apply\n"})}),"\n",(0,r.jsx)(n.p,{children:"Wait for the resources to get applied to your cluster, and then you should be able seeing\r\nthe services and pods of ISTIO and Prometheus in their respective namespaces."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"kubectl get po,svc -n istio-system\n"})}),"\n",(0,r.jsx)(n.p,{children:"Output:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"NAME                                        READY   STATUS    RESTARTS   AGE\r\npod/istio-cni-node-5sb65                    1/1     Running   0          61s\r\npod/istio-cni-node-jxqs7                    1/1     Running   0          61s\r\npod/istio-cni-node-k226f                    1/1     Running   0          61s\r\npod/istio-ingressgateway-5fc9f486fc-jt748   1/1     Running   0          42s\r\npod/istiod-776dbc9dc-7js84                  1/1     Running   0          55s\r\n\r\nNAME                           TYPE           CLUSTER-IP      EXTERNAL-IP                                                              PORT(S)                                      AGE\r\nservice/istio-ingressgateway   LoadBalancer   172.20.72.194   a59e84a877b5d45e8a6cf897a436a9a9-394493815.us-east-1.elb.amazonaws.com   15021:31196/TCP,80:32305/TCP,443:31608/TCP   42s\r\nservice/istiod                 ClusterIP      172.20.51.28    <none>                                                                   15010/TCP,15012/TCP,443/TCP,15014/TCP        56s\n"})}),"\n",(0,r.jsx)(n.p,{children:"Enabling Istio will create a classic load balancer for Istio Ingress gateway as you notice in the preceeding output."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"kubectl get po,svc -n prometheus\n"})}),"\n",(0,r.jsx)(n.p,{children:"Output:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"NAME                                                         READY   STATUS    RESTARTS   AGE\r\npod/alertmanager-prometheus-kube-prometheus-alertmanager-0   2/2     Running   0          56s\r\npod/prometheus-grafana-69cd67cb67-mc6p9                      3/3     Running   0          60s\r\npod/prometheus-kube-prometheus-operator-6794f987b-55ft8      1/1     Running   0          60s\r\npod/prometheus-kube-state-metrics-94f76f559-lbgr4            1/1     Running   0          60s\r\npod/prometheus-prometheus-kube-prometheus-prometheus-0       2/2     Running   0          56s\r\npod/prometheus-prometheus-node-exporter-pz8p5                1/1     Running   0          60s\r\npod/prometheus-prometheus-node-exporter-qdgjs                1/1     Running   0          60s\r\npod/prometheus-prometheus-node-exporter-vffgh                1/1     Running   0          60s\r\n\r\nNAME                                              TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE\r\nservice/alertmanager-operated                     ClusterIP   None             <none>        9093/TCP,9094/TCP,9094/UDP   56s\r\nservice/prometheus-grafana                        ClusterIP   172.20.160.55    <none>        80/TCP                       60s\r\nservice/prometheus-kube-prometheus-alertmanager   ClusterIP   172.20.211.50    <none>        9093/TCP                     60s\r\nservice/prometheus-kube-prometheus-operator       ClusterIP   172.20.58.96     <none>        443/TCP                      60s\r\nservice/prometheus-kube-prometheus-prometheus     ClusterIP   172.20.4.219     <none>        9090/TCP                     60s\r\nservice/prometheus-kube-state-metrics             ClusterIP   172.20.87.244    <none>        8080/TCP                     60s\r\nservice/prometheus-operated                       ClusterIP   None             <none>        9090/TCP                     56s\r\nservice/prometheus-prometheus-node-exporter       ClusterIP   172.20.180.230   <none>        9100/TCP                     60s\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Enabling Prometheus will create an application load balancer (ALB) for Promethes and Grafana, because that what we have passed to the helm chart to set while Installing the ",(0,r.jsx)(n.code,{children:"kube-prometheus-stack"})," helm chart."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Prometheus LBs",src:s(7032).A+"",width:"1255",height:"225"})}),"\n",(0,r.jsxs)(n.p,{children:["Test accessing the loadbalancer endpoint of Prometheus which should be up and running and then check if you can Istio metrics. It should show no Istio metrics yet, which would show  in the next section ",(0,r.jsx)(n.em,{children:(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.a,{href:"/istio-service-mesh-on-eks/docs/setup/expose-istio-metrics",children:"Exposing ISTIO Metrics to Prometheus"})})}),"."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"No Istio Metrics",src:s(217).A+"",width:"725",height:"553"})}),"\n",(0,r.jsxs)(n.p,{children:["Test accessing the loadbalancer endpoints of Grafana oging to Grafana with the follwoing default credential (username: ",(0,r.jsx)(n.code,{children:"admin"})," and password: ",(0,r.jsx)(n.code,{children:"prom-operator"}),"). Rememeber to change those default credentilas."]}),"\n",(0,r.jsxs)(n.p,{children:["Grafana should be up and running. Check for ISTIO dashboards. It should show no Istio dashbpards yet, which would show  in the next section ",(0,r.jsx)(n.em,{children:(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.a,{href:"/istio-service-mesh-on-eks/docs/setup/expose-istio-metrics",children:"Exposing ISTIO Metrics to Prometheus"})})}),"."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"No Istio dashboard",src:s(2619).A+"",width:"968",height:"511"})}),"\n",(0,r.jsx)(n.p,{children:"Next step, we need to expose ISTIO metrics to Pometheus."})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},2619:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/no_istio_dashboards-5985ff2081dcce38902d6354da2c622d.png"},217:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/no_istio_metrics-142552bddc549abd663b064ad8bce891.png"},7032:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/images/prometheus-lb-a273b4d54edc9f72987b28ba34aae42f.png"},8453:(e,n,s)=>{s.d(n,{R:()=>a,x:()=>i});var r=s(6540);const t={},o=r.createContext(t);function a(e){const n=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),r.createElement(o.Provider,{value:n},e.children)}}}]);