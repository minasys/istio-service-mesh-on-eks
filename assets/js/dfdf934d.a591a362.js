"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([[6335],{1852:(e,o,r)=>{r.r(o),r.d(o,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>n,metadata:()=>a,toc:()=>d});var t=r(4848),s=r(8453);const n={title:"Exposing ISTIO Metrics to Prometheus",sidebar_position:40},i=void 0,a={id:"setup/expose-istio-metrics",title:"Exposing ISTIO Metrics to Prometheus",description:"In this section, you configure Prometheus-Operator resources to scrape metrics from Istio to Prometheus and install the Grafana Dashboards.",source:"@site/docs/10-setup/40-expose-istio-metrics.md",sourceDirName:"10-setup",slug:"/setup/expose-istio-metrics",permalink:"/docs/setup/expose-istio-metrics",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/10-setup/40-expose-istio-metrics.md",tags:[],version:"current",sidebarPosition:40,frontMatter:{title:"Exposing ISTIO Metrics to Prometheus",sidebar_position:40},sidebar:"setupSidebar",previous:{title:"Enabling ISTIO and Prometheus",permalink:"/docs/setup/enabling-istio-and-prometheus"},next:{title:"Installing Kiali and Jaeger",permalink:"/docs/setup/installing-istio-addons"}},c={},d=[{value:"Configuring Prometheus operator to monitor Istio control plane",id:"configuring-prometheus-operator-to-monitor-istio-control-plane",level:3},{value:"Configuring Prometheus operator to monitor Istio data plane",id:"configuring-prometheus-operator-to-monitor-istio-data-plane",level:3},{value:"Checking Prometheus for Istio Metrics:",id:"checking-prometheus-for-istio-metrics",level:3},{value:"Enabling Istio dashboard in Grafana",id:"enabling-istio-dashboard-in-grafana",level:3}];function l(e){const o={a:"a",code:"code",h3:"h3",img:"img",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(o.p,{children:"In this section, you configure Prometheus-Operator resources to scrape metrics from Istio to Prometheus and install the Grafana Dashboards."}),"\n",(0,t.jsx)(o.p,{children:"In the following step, you deploy a ServiceMonitor resource that describes which pods to scrape based on a Service. In Istio, we have two types of things to monitor: Istio control-plane resources and Istio-proxy data-plane. For that we create 2 different ServiceMonitor resources."}),"\n",(0,t.jsx)(o.h3,{id:"configuring-prometheus-operator-to-monitor-istio-control-plane",children:"Configuring Prometheus operator to monitor Istio control plane"}),"\n",(0,t.jsxs)(o.p,{children:["The following resource is to configure Prometheus operator to monitor Istio control plane by looking for any service with label istio equal to ",(0,t.jsx)(o.code,{children:"[mixer,pilot,galley,citadel,sidecar-injector]"})," and it configures it to scrap metrics from ports ",(0,t.jsx)(o.code,{children:"http-monitoring"})," and ",(0,t.jsx)(o.code,{children:"http-policy-monitoring"})," every 15 seconds."]}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{className:"language-yaml",children:"kubectl apply -f - <<EOF\r\napiVersion: monitoring.coreos.com/v1\r\nkind: ServiceMonitor\r\nmetadata:\r\n  name: prometheus-oper-istio-controlplane\r\n  labels:\r\n    # The labels here are selectors that MUST match the Prometheus install serviceMonitorSelector. \r\n    # If you fail to do so, Prometheus will not consider this resource.\r\n    release: prometheus\r\nspec:\r\n  jobLabel: istio\r\n\r\n  # the spec.selector label tells Prometheus which services should be scraped. \r\n  # in this case it will be istiod, as it has the label istio with on of the following \r\n  # values [mixer,pilot,galley,citadel,sidecar-injector]   \r\n  selector:\r\n    matchExpressions:\r\n      - {key: istio, operator: In, values: [mixer,pilot,galley,citadel,sidecar-injector]}\r\n\r\n  # By default, Prometheus will only pick up ServiceMonitors from the current namespace. \r\n  # To select ServiceMonitors from other namespaces, you can update the \r\n  # spec.serviceMonitorNamespaceSelector field of the Prometheus resource.      \r\n  namespaceSelector:\r\n    any: true\r\n\r\n  # Here it scrapes port named http-monitoring and http-policy-monitoring every 15s\r\n  endpoints:\r\n  - port: http-monitoring\r\n    interval: 15s\r\n  - port: http-policy-monitoring\r\n    interval: 15s\r\nEOF\n"})}),"\n",(0,t.jsx)(o.p,{children:"The only thing to be careful about are the labels at the beginning of the preceeding ServiceMontor resource. Those lables are selectors that must match the serviceMonitorSelector property of the Prometheus resource running in the prometheus namespace . If you fail to do so, Prometheus will not consider this ServiceMonitor resource."}),"\n",(0,t.jsx)(o.p,{children:"You can check how yours is configured by looking at the prometheus resource:"}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{className:"language-shell",children:"kubectl get prometheus -n prometheus -o yaml | grep -A4 serviceMonitorSelector    \n"})}),"\n",(0,t.jsx)(o.p,{children:"Output:"}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{className:"language-yaml",children:"serviceMonitorSelector:\r\n      matchLabels:\r\n        release: prometheus\n"})}),"\n",(0,t.jsxs)(o.p,{children:["In my case, it is ",(0,t.jsx)(o.code,{children:"release: prometheus"})," which matches the label of the ServiceMonitor resource above."]}),"\n",(0,t.jsx)(o.h3,{id:"configuring-prometheus-operator-to-monitor-istio-data-plane",children:"Configuring Prometheus operator to monitor Istio data plane"}),"\n",(0,t.jsxs)(o.p,{children:["The data-plane resource has the same configurations, but this time it targets all ",(0,t.jsx)(o.code,{children:"Istio-Proxy"})," containers. It scraps metrics from port ",(0,t.jsx)(o.code,{children:"http-envoy-prom"})," on the path ",(0,t.jsx)(o.code,{children:"/stats/prometheus"})," every 15 seconds. In addition, it adds some relabeling."]}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{className:"language-yaml",children:"kubectl apply -f - <<EOF\r\napiVersion: monitoring.coreos.com/v1\r\nkind: ServiceMonitor\r\nmetadata:\r\n  name: prometheus-oper-istio-dataplane\r\n  labels:\r\n    monitoring: istio-dataplane\r\n    release: prometheus\r\nspec:\r\n  selector:\r\n    matchExpressions:\r\n      - {key: istio-prometheus-ignore, operator: DoesNotExist}\r\n  namespaceSelector:\r\n    any: true\r\n  jobLabel: envoy-stats\r\n  endpoints:\r\n  - path: /stats/prometheus\r\n    targetPort: http-envoy-prom\r\n    interval: 15s\r\n    relabelings:\r\n    # The source labels select values from existing labels. Their content are matched \r\n    # against the configured regular expression or target label for the replace, keep, and drop actions.\r\n    # For more info: \r\n    # https://prometheus.io/docs/prometheus/latest/configuration/configuration/#metric_relabel_configs\r\n    - sourceLabels: [__meta_kubernetes_pod_container_port_name]\r\n      # keep: Drop targets for which regex does not match the concatenated source_labels.\r\n      action: keep\r\n      regex: '.*-envoy-prom'\r\n    - action: labelmap\r\n      regex: \"__meta_kubernetes_pod_label_(.+)\"\r\n\r\n      # Label to which the resulting value is written in a replace action.\r\n      # It is mandatory for replace actions.\r\n    - sourceLabels: [__meta_kubernetes_namespace]\r\n      # replace: replace source label with the traget label\r\n      action: replace\r\n      targetLabel: namespace\r\n    - sourceLabels: [__meta_kubernetes_pod_name]\r\n      action: replace\r\n      targetLabel: pod_name\r\nEOF\n"})}),"\n",(0,t.jsx)(o.p,{children:"Make sure you have the correct label to allow Prometheus Operator to manage the resource."}),"\n",(0,t.jsxs)(o.p,{children:["If you don't want Prometheus to scrape the Istio-proxy's metrics, add the label ",(0,t.jsx)(o.code,{children:"istio-prometheus-ignore=\u201dtrue\u201d"})," to your deployments."]}),"\n",(0,t.jsx)(o.h3,{id:"checking-prometheus-for-istio-metrics",children:"Checking Prometheus for Istio Metrics:"}),"\n",(0,t.jsxs)(o.p,{children:["Wait a few seconds from deploying the preceeding two ServiceMonitor resources, then connect to your Prometheus LB endpoint, and search istio metrics.\r\n",(0,t.jsx)(o.img,{alt:"Istio Metrics",src:r(1801).A+"",width:"889",height:"367"})]}),"\n",(0,t.jsx)(o.h3,{id:"enabling-istio-dashboard-in-grafana",children:"Enabling Istio dashboard in Grafana"}),"\n",(0,t.jsxs)(o.p,{children:["Now, you may want to see Istio metrics presented in graphs within Grafana, and for that purpose, you can find Istio dashboards stored in ",(0,t.jsx)(o.a,{href:"https://github.com/istio/istio/tree/master/manifests/addons/dashboards",children:"Istio Github repo"}),"."]}),"\n",(0,t.jsx)(o.p,{children:(0,t.jsx)(o.img,{alt:"Istio dashboards",src:r(6587).A+"",width:"767",height:"495"})}),"\n",(0,t.jsx)(o.p,{children:"Create a directory and download them all into that directory"}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{className:"language-shell",children:"mkdir dashboards\r\ncd dashboards\r\ncurl -o ./istio-extension-dashboard.json https://raw.githubusercontent.com/istio/istio/master/manifests/addons/dashboards/istio-extension-dashboard.json \r\ncurl -o ./istio-mesh-dashboard.json https://raw.githubusercontent.com/istio/istio/master/manifests/addons/dashboards/istio-mesh-dashboard.json \r\ncurl -o ./istio-performance-dashboard.json https://raw.githubusercontent.com/istio/istio/master/manifests/addons/dashboards/istio-performance-dashboard.json \r\ncurl -o ./istio-service-dashboard.json https://raw.githubusercontent.com/istio/istio/master/manifests/addons/dashboards/istio-service-dashboard.json \r\ncurl -o ./istio-workload-dashboard.json https://raw.githubusercontent.com/istio/istio/master/manifests/addons/dashboards/istio-workload-dashboard.json \r\ncurl -o ./pilot-dashboard.json https://raw.githubusercontent.com/istio/istio/master/manifests/addons/dashboards/pilot-dashboard.json \n"})}),"\n",(0,t.jsx)(o.p,{children:"After downloading them, you need to copy them inside a kubernetes configmap. assuming you are in the same directory having the dashoards, run the following command into it."}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{className:"language-shell",children:"kubectl -n prometheus create cm istio-dashboards \\\r\n--from-file=pilot-dashboard.json=./pilot-dashboard.json \\\r\n--from-file=istio-workload-dashboard.json=./istio-workload-dashboard.json \\\r\n--from-file=istio-service-dashboard.json=./istio-service-dashboard.json \\\r\n--from-file=istio-performance-dashboard.json=./istio-performance-dashboard.json \\\r\n--from-file=istio-mesh-dashboard.json=./istio-mesh-dashboard.json \\\r\n--from-file=istio-extension-dashboard.json=./istio-extension-dashboard.json\n"})}),"\n",(0,t.jsx)(o.p,{children:"Label the configmap so it is used by Grafana"}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{className:"language-shell",children:"kubectl label -n prometheus cm istio-dashboards grafana_dashboard=1\n"})}),"\n",(0,t.jsx)(o.p,{children:"Redeploy the Grafana pod by deleting it; the prometheus-grafana deployment will recreate it for you."}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{className:"language-shell",children:"kubectl delete pod -n prometheus -l app.kubernetes.io/name=grafana\n"})}),"\n",(0,t.jsxs)(o.p,{children:["Wait seconds before re-logging to Grafana LB endpoint, and you should see the Dashboards in Grafana.\r\n",(0,t.jsx)(o.img,{alt:"Istio Grafana dashboards",src:r(8274).A+"",width:"625",height:"830"}),"\r\n",(0,t.jsx)(o.img,{alt:"istio_cp_db",src:r(5228).A+"",width:"1873",height:"862"})]})]})}function h(e={}){const{wrapper:o}={...(0,s.R)(),...e.components};return o?(0,t.jsx)(o,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}},5228:(e,o,r)=>{r.d(o,{A:()=>t});const t=r.p+"assets/images/istio_cp_db-d8e0a033818d829037db352ff27139db.png"},6587:(e,o,r)=>{r.d(o,{A:()=>t});const t=r.p+"assets/images/istio_dashboards-eb58699d879f1ca031b97604cbd6a787.png"},8274:(e,o,r)=>{r.d(o,{A:()=>t});const t=r.p+"assets/images/istio_dashboards_grafana-16a7319ee608ff205551656f905d5313.png"},1801:(e,o,r)=>{r.d(o,{A:()=>t});const t=r.p+"assets/images/istio_metrics-0814012785185ddf4d716a111eb9fb0e.png"},8453:(e,o,r)=>{r.d(o,{R:()=>i,x:()=>a});var t=r(6540);const s={},n=t.createContext(s);function i(e){const o=t.useContext(n);return t.useMemo((function(){return"function"==typeof e?e(o):{...o,...e}}),[o,e])}function a(e){let o;return o=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),t.createElement(n.Provider,{value:o},e.children)}}}]);